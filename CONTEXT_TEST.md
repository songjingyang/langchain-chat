# 上下文记忆功能测试指南

## 🧪 测试场景

### 1. 基础上下文记忆测试
**步骤：**
1. 启动应用：`npm run dev`
2. 发送第一条消息："我的名字是张三"
3. 发送第二条消息："我的名字是什么？"
4. **预期结果：** AI应该回答"您的名字是张三"

### 2. 多轮对话测试
**步骤：**
1. 发送："我喜欢吃苹果"
2. 发送："我还喜欢吃香蕉"
3. 发送："我喜欢吃什么水果？"
4. **预期结果：** AI应该回答包含苹果和香蕉

### 3. 上下文限制测试
**步骤：**
1. 连续发送多条消息（超过20条）
2. 观察上下文状态栏的变化
3. **预期结果：** 
   - 状态栏显示消息数量和token估算
   - 超过限制时显示"已自动截断"
   - 早期消息被自动移除

### 4. 模型切换测试
**步骤：**
1. 使用OpenAI模型进行对话
2. 切换到Groq模型
3. 继续对话
4. **预期结果：** 
   - 上下文在模型切换后保持
   - 不同模型有不同的上下文限制

### 5. 清除上下文测试
**步骤：**
1. 进行几轮对话
2. 点击"清除上下文"按钮
3. 发送新消息询问之前的内容
4. **预期结果：** AI不记得之前的对话内容

## 🔍 验证要点

### UI显示验证
- ✅ 上下文状态栏正确显示消息数量
- ✅ Token估算显示合理数值
- ✅ 超限时显示警告状态
- ✅ 清除按钮功能正常

### API功能验证
- ✅ 历史消息正确发送到API
- ✅ 上下文自动截断生效
- ✅ 不同模型使用不同配置
- ✅ 控制台日志显示上下文统计

### 对话质量验证
- ✅ AI能引用之前的对话内容
- ✅ 多轮对话保持连贯性
- ✅ 上下文截断后仍能正常对话
- ✅ 清除上下文后重新开始

## 🐛 常见问题排查

### 问题1：AI不记得之前的对话
**可能原因：**
- 上下文消息未正确发送
- API路由处理有误
- 消息格式转换错误

**排查方法：**
- 检查浏览器开发者工具Network标签
- 查看API请求是否包含messages字段
- 检查服务器控制台日志

### 问题2：上下文状态显示异常
**可能原因：**
- Token估算算法有误
- 配置参数不正确
- 组件状态更新问题

**排查方法：**
- 检查ContextStatus组件渲染
- 验证配置文件中的参数
- 查看浏览器控制台错误

### 问题3：性能问题
**可能原因：**
- 上下文过长导致请求缓慢
- Token估算计算量大
- 频繁的状态更新

**排查方法：**
- 调整maxTokens和maxMessages参数
- 优化Token估算算法
- 使用React.memo优化组件渲染

## 📊 性能指标

### 不同模型的上下文配置
| 模型 | 最大消息数 | 最大Tokens | 策略 |
|------|------------|------------|------|
| OpenAI | 20 | 3000 | recent |
| Groq | 15 | 2500 | recent |
| Google | 25 | 4000 | recent |

### 预期响应时间
- 短上下文（<10条消息）：< 2秒
- 中等上下文（10-20条消息）：< 3秒
- 长上下文（>20条消息，截断后）：< 4秒
